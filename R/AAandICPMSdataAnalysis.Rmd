---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```{r}
library(readr)
ICPMS_tidy_example <- read_csv("~/Chem313Lab05AJed/Chem311_JCWSoil/Data/ICPMS_tidy_example.csv")
AA_tidy_example <- read_csv("~/Chem313Lab05AJed/Chem311_JCWSoil/Data/tidy_AA.csv")
ICPMS_tidy_example
```

```{r}
sample_sites <- unique(filter(ICPMS_tidy_example, site!="MB", site!="")$site) # excludeing method blank and quality control from list of sites
metals_analyzed <- unique(ICPMS_tidy_example$metal)

#Preview the lists to check for potential issues:
sample_sites
metals_analyzed
```

3) Use for loop the create calibration curve
```{r Calibration}
ICPMS_cal <- NULL
for (unique_metal in metals_analyzed){
  cal <- ICPMS_tidy_example %>%
    filter(type == "Cal1" | type == "Cal2" | type == "Cal3") %>%
    filter(metal == unique_metal) %>%
    select(concentration, cps, rsd)
  
  #account for the uncertainty in the cps by weighting the regression with the RSD readings
  w <- 1/(cal$cps*cal$rsd)^2
  model <- lm(cal$cps ~ cal$concentration, weights=w) 
  
  slope <- model$coefficients[2]
  intercept <- model$coefficients[1]
  slope_std <- summary(model)$coefficients[2,2]
  intercept_std <- summary(model)$coefficients[1,2]
  
  #Calibration curve is plotted
  plot(cal$cps ~ cal$concentration,
       xlab= paste("Concentration of ", unique_metal, "(ppb)"), #units from the standard solution prepared at OHSU (micrograms/L)
       ylab= "Counts per second")+
    abline(model, col="red")+
    title(paste("Calibration for", unique_metal))
  
  equation <- tibble(metal= unique_metal, slope, slope_std, intercept, intercept_std)
  ICPMS_cal <- rbind(ICPMS_cal, equation)
}

ICPMS_cal
#Clearing the environment (optional, but helps to prevent accidently using the wrong object)
## remove(equation, cal, slope, slope_std, intercept, intercept_std, w, model, unique_metal)
```

4) Create a function to expedite the sample analysis
```{r}
#inputs: unique_site (as a character, ex. "A")
#outputs: concentration vector

sample_analysis <- function(unique_site){
  concentration_data <- NULL
  for (unique_metal in metals_analyzed){
    sample <- filter(ICPMS_tidy_example, metal == unique_metal, site == unique_site)
    data <- NULL
    
    for(ID in sample$sample_key){
      sample_data <- filter(sample, sample_key == ID)
      cal <- filter(ICPMS_cal, metal == unique_metal)
      
      #Sample Analysis
      m <- cal$slope
      b <- cal$intercept
      y <- sample_data$cps
      
      b_e <- cal$intercept_std
      m_e <- cal$slope_std
      
      x <- (y-b)/m #The units are dependent on the calibration standerds (Kg/mL)
      
      
      RSD <- sample_data$rsd
      CPS <- sample_data$cps
      
      #Error Propagation
      e_yb <- sqrt(((RSD/100)*CPS)^2 + (b_e)^2) #Error in y-b from the calibration
      yb <- CPS-b
      e_x <- x*sqrt((e_yb/yb)^2 + (m_e/m)^2) #Error in x from the calibration
      
      data <- rbind(data, data_frame(sample_key = ID, x, e_x))
      if (unique_site != "MB"){
        concentration_data <- data.frame(sample_key = sample_data$sample_key,
                                         analyst = sample_data$analyst,
                                         metal = unique_metal,
                                         site = unique_site,
                                         conc_dil = x,
                                         conc_dil_error = e_x) %>%
          rbind(concentration_data)
      }
    }
    if (unique_site=="MB"){
        x <- mean(data$x)
        e_x <- sd(data$x) #reasign e_x as a veriable?
        concentration_data <- data.frame(metal = unique_metal,
                                         site = unique_site,
                                         conc_dil = x,
                                         conc_dil_error = e_x) %>%
          rbind(concentration_data)
      }
    }
    return(concentration_data)
}
```

5) Create a function that runs a different function on each of the soil sample sites
```{r}
#input: a function
#output: a data frame with the function outputs from each site
run_sites <- function(Function) {
  value <- NULL
  for(sites in sample_sites){
    site_value <- Function(sites)
    value <- rbind(site_value, value)
  }
  return(value)
}
```

6) Analyze the method blank and all the samples
```{r}
MB <- sample_analysis("MB") #(micrograms/kg)
uncor_sample <- run_sites(sample_analysis) #values do not account for dilutions (mucrograms/kg)

#Preview
MB
uncor_sample
```

7) Correct for the method blank and perform error propagation as needed
```{r}
sample_data_mb <- NULL

for (unique_metal in metals_analyzed){
  MB_metal <- filter(MB, metal == unique_metal)
  sample_metal <- filter(uncor_sample, metal == unique_metal)
  conc_dil_blanked <- (sample_metal$conc_dil)-(MB_metal$conc_dil)
  
  #Error Propigation: subtraction of MB
  conc_dil_blanked_error <- sqrt((sample_metal$conc_dil_error)^2 + (MB_metal$conc_dil_error)^2)
  
  sample_data_mb <- sample_metal %>%
    mutate(conc_dil_blanked, conc_dil_blanked_error)%>%
    rbind(sample_data_mb)
}

sample_data_mb
```

7.5) --> look at lab procedure, slid 23

8) Dilutions Correction
```{r}
#error propigation
vol_e <- 1
mass_e <- 0.001
dil_1010_e <- sqrt(1^2 + 10^2)
dil_e <- sqrt((dil_1010_e/1010)^2 + (1/10)^2) #error in 101 dilution factor

sample_data <- merge(ICPMS_tidy_example, sample_data_mb)%>% #This adds in important details such as soil mass
  unique()%>%
  mutate(conc_blanked = conc_dil_blanked*(total_volume/1000)/(mass_of_soil/1000)*101, #101 is the factor diluted by at OHSU to make the solutions dilute enough to run ICPMS on.
         conc_blanked_error = conc_blanked*
           sqrt((conc_dil_blanked_error/conc_dil_blanked)^2 + 
                  (dil_e/101)^2 +
                  (mass_e/mass_of_soil)^2 +
                  (vol_e/total_volume)^2),
         conc_unblanked = conc_dil*(total_volume/1000)/(mass_of_soil/1000)*101,
         conc_unblanked_error = conc_unblanked*
           sqrt((conc_dil_error/conc_dil)^2 +
                  (dil_e/101)^2 +
                  (mass_e/mass_of_soil)^2 +
                  (vol_e/total_volume)^2))%>%
  select(-concentration, #removing unecessary columns
         -type,
         -mass_of_soil,
         -total_volume,
         -cps,
         -rsd,
         -conc_dil_blanked,
         -conc_dil_blanked_error,
         -conc_dil,
         -conc_dil_error)

sample_data
```

```{r}
ICPMS_sample_data <- filter(sample_data, metal == "Cr53")

ICPMS_AllData <- subset(sample_data, select = -c(analyst, X1, conc_unblanked, conc_unblanked_error)) %>%
  rename(
    Blanked_Concentration = conc_blanked,
    Blanked_Concentration_Error = conc_blanked_error
  )
ICPMS_AllData
```

USE THIS FOR ICPMS:
```{r Metals Averaged ICP-MS}
ICPMS_AllData_Av <- ICPMS_AllData %>%
  group_by(metal)%>%
  group_by(site, add = TRUE)%>%
  summarise(Concentation_ofMetal = mean(Blanked_Concentration), Concentration_Error_perSite = sd(Blanked_Concentration_Error), CI = (qnorm(0.975)*Concentration_Error_perSite/sqrt(length(site))) )


#make bar pot of this w/ CI as error bars x = site, y = metal concentation, fill = metal
ICPMS_AllData_Av
CIAs75
```

CI
```{r}
SiteA_Data <- ICPMS_AllData %>%
  filter(site == "A")
SiteB_Data <- ICPMS_AllData %>%
  filter(site == "B")
SiteC_Data <- ICPMS_AllData %>%
  filter(site == "C")
SiteD_Data <- ICPMS_AllData %>%
  filter(site == "D")
SiteE_Data <- ICPMS_AllData %>%
  filter(site == "E")
SiteF_Data <- ICPMS_AllData %>%
  filter(site == "F")

for(unique_metal in SiteA_Data){
  CI_A <- qt(0.95, df = length(SiteA_Data$unique_metal) -1)*ICPMS_AllData_Av$Concentration_Error/sqrt(length(SiteA_Data$unique_metal))
}

#  CI_A = (qnorm(0.975)*sd(length(SiteA_Data$unique_metal)/sqrt(length(SiteA_Data$unique_metal))))

SiteA_Data
SiteB_Data
SiteC_Data
SiteD_Data
SiteE_Data
SiteF_Data
CI_A
```
```{r Averaging site data}
#---------
SiteA_As75 <- filter(SiteA_Data, metal == "As75")
SiteA_As75_Av <- mean(SiteA_As75$Blanked_Concentration)

SiteA_Cd111 <- filter(SiteA_Data, metal == "Cd111")
SiteA_Cd111_Av <- mean(SiteA_Cd111$Blanked_Concentration)

SiteA_Cd114 <- filter(SiteA_Data, metal == "Cd114")
SiteA_Cd114_Av <- mean(SiteA_Cd114$Blanked_Concentration)

SiteA_Cr52 <- filter(SiteA_Data, metal == "Cr52")
SiteA_Cr52_Av <- mean(SiteA_Cr52$Blanked_Concentration)

SiteA_Cr53 <- filter(SiteA_Data, metal == "Cr53")
SiteA_Cr53_Av <- mean(SiteA_Cr53$Blanked_Concentration)

SiteA_Pb208 <- filter(SiteA_Data, metal == "Pb208")
SiteA_Pb208_Av <- mean(SiteA_Pb208$Blanked_Concentration)

SiteA_As75_er <- sd(SiteA_As75$Blanked_Concentration_Error)
SiteA_Cd111_er <- sd(SiteA_Cd111$Blanked_Concentration_Error)
SiteA_Cd114_er <- sd(SiteA_Cd114$Blanked_Concentration_Error)
SiteA_Cr52_er <- sd(SiteA_Cr52$Blanked_Concentration_Error)
SiteA_Cr53_er <- sd(SiteA_Cr53$Blanked_Concentration_Error)
SiteA_Pb208_er <- sd(SiteA_Pb208$Blanked_Concentration_Error)
SiteA_er <- c(SiteA_As75_er, SiteA_Cd111_er, SiteA_Cd114_er, SiteA_Cr52_er, SiteA_Cr53_er, SiteA_Pb208_er)


SiteA_Av <- c(SiteA_As75_Av, SiteA_Cd111_Av, SiteA_Cd114_Av, SiteA_Cr52_Av, SiteA_Cr53_Av, SiteA_Pb208_Av)

#---------
SiteB_As75 <- filter(SiteB_Data, metal == "As75")
SiteB_As75_Av <- mean(SiteB_As75$Blanked_Concentration)

SiteB_Cd111 <- filter(SiteB_Data, metal == "Cd111")
SiteB_Cd111_Av <- mean(SiteB_Cd111$Blanked_Concentration)

SiteB_Cd114 <- filter(SiteB_Data, metal == "Cd114")
SiteB_Cd114_Av <- mean(SiteB_Cd114$Blanked_Concentration)

SiteB_Cr52 <- filter(SiteB_Data, metal == "Cr52")
SiteB_Cr52_Av <- mean(SiteB_Cr52$Blanked_Concentration)

SiteB_Cr53 <- filter(SiteB_Data, metal == "Cr53")
SiteB_Cr53_Av <- mean(SiteB_Cr53$Blanked_Concentration)

SiteB_Pb208 <- filter(SiteB_Data, metal == "Pb208")
SiteB_Pb208_Av <- mean(SiteB_Pb208$Blanked_Concentration)

SiteB_Av <- c(SiteB_As75_Av, SiteB_Cd111_Av, SiteB_Cd114_Av, SiteB_Cr52_Av, SiteB_Cr53_Av, SiteB_Pb208_Av)

SiteB_As75_er <- sd(SiteB_As75$Blanked_Concentration_Error)
SiteB_Cd111_er <- sd(SiteB_Cd111$Blanked_Concentration_Error)
SiteB_Cd114_er <- sd(SiteB_Cd114$Blanked_Concentration_Error)
SiteB_Cr52_er <- sd(SiteB_Cr52$Blanked_Concentration_Error)
SiteB_Cr53_er <- sd(SiteB_Cr53$Blanked_Concentration_Error)
SiteB_Pb208_er <- sd(SiteB_Pb208$Blanked_Concentration_Error)
SiteB_er <- c(SiteB_As75_er, SiteB_Cd111_er, SiteB_Cd114_er, SiteB_Cr52_er, SiteB_Cr53_er, SiteB_Pb208_er)
#---------
SiteC_As75 <- filter(SiteC_Data, metal == "As75")
SiteC_As75_Av <- mean(SiteC_As75$Blanked_Concentration)

SiteC_Cd111 <- filter(SiteC_Data, metal == "Cd111")
SiteC_Cd111_Av <- mean(SiteC_Cd111$Blanked_Concentration)

SiteC_Cd114 <- filter(SiteC_Data, metal == "Cd114")
SiteC_Cd114_Av <- mean(SiteC_Cd114$Blanked_Concentration)

SiteC_Cr52 <- filter(SiteC_Data, metal == "Cr52")
SiteC_Cr52_Av <- mean(SiteC_Cr52$Blanked_Concentration)

SiteC_Cr53 <- filter(SiteC_Data, metal == "Cr53")
SiteC_Cr53_Av <- mean(SiteC_Cr53$Blanked_Concentration)

SiteC_Pb208 <- filter(SiteC_Data, metal == "Pb208")
SiteC_Pb208_Av <- mean(SiteC_Pb208$Blanked_Concentration)

SiteC_Av <- c(SiteC_As75_Av, SiteC_Cd111_Av, SiteC_Cd114_Av, SiteC_Cr52_Av, SiteC_Cr53_Av, SiteC_Pb208_Av)

SiteC_As75_er <- sd(SiteC_As75$Blanked_Concentration_Error)
SiteC_Cd111_er <- sd(SiteC_Cd111$Blanked_Concentration_Error)
SiteC_Cd114_er <- sd(SiteC_Cd114$Blanked_Concentration_Error)
SiteC_Cr52_er <- sd(SiteC_Cr52$Blanked_Concentration_Error)
SiteC_Cr53_er <- sd(SiteC_Cr53$Blanked_Concentration_Error)
SiteC_Pb208_er <- sd(SiteC_Pb208$Blanked_Concentration_Error)
SiteC_er <- c(SiteC_As75_er, SiteC_Cd111_er, SiteC_Cd114_er, SiteC_Cr52_er, SiteC_Cr53_er, SiteC_Pb208_er)
#---------
SiteD_As75 <- filter(SiteD_Data, metal == "As75")
SiteD_As75_Av <- mean(SiteD_As75$Blanked_Concentration)

SiteD_Cd111 <- filter(SiteD_Data, metal == "Cd111")
SiteD_Cd111_Av <- mean(SiteD_Cd111$Blanked_Concentration)

SiteD_Cd114 <- filter(SiteD_Data, metal == "Cd114")
SiteD_Cd114_Av <- mean(SiteD_Cd114$Blanked_Concentration)

SiteD_Cr52 <- filter(SiteD_Data, metal == "Cr52")
SiteD_Cr52_Av <- mean(SiteD_Cr52$Blanked_Concentration)

SiteD_Cr53 <- filter(SiteD_Data, metal == "Cr53")
SiteD_Cr53_Av <- mean(SiteD_Cr53$Blanked_Concentration)

SiteD_Pb208 <- filter(SiteD_Data, metal == "Pb208")
SiteD_Pb208_Av <- mean(SiteD_Pb208$Blanked_Concentration)

SiteD_Av <- c(SiteD_As75_Av, SiteD_Cd111_Av, SiteD_Cd114_Av, SiteD_Cr52_Av, SiteD_Cr53_Av, SiteD_Pb208_Av)

SiteD_As75_er <- sd(SiteD_As75$Blanked_Concentration_Error)
SiteD_Cd111_er <- sd(SiteD_Cd111$Blanked_Concentration_Error)
SiteD_Cd114_er <- sd(SiteD_Cd114$Blanked_Concentration_Error)
SiteD_Cr52_er <- sd(SiteD_Cr52$Blanked_Concentration_Error)
SiteD_Cr53_er <- sd(SiteD_Cr53$Blanked_Concentration_Error)
SiteD_Pb208_er <- sd(SiteD_Pb208$Blanked_Concentration_Error)
SiteD_er <- c(SiteD_As75_er, SiteD_Cd111_er, SiteD_Cd114_er, SiteD_Cr52_er, SiteD_Cr53_er, SiteD_Pb208_er)
#---------
SiteE_As75 <- filter(SiteE_Data, metal == "As75")
SiteE_As75_Av <- mean(SiteE_As75$Blanked_Concentration)

SiteE_Cd111 <- filter(SiteE_Data, metal == "Cd111")
SiteE_Cd111_Av <- mean(SiteE_Cd111$Blanked_Concentration)

SiteE_Cd114 <- filter(SiteE_Data, metal == "Cd114")
SiteE_Cd114_Av <- mean(SiteE_Cd114$Blanked_Concentration)

SiteE_Cr52 <- filter(SiteE_Data, metal == "Cr52")
SiteE_Cr52_Av <- mean(SiteE_Cr52$Blanked_Concentration)

SiteE_Cr53 <- filter(SiteE_Data, metal == "Cr53")
SiteE_Cr53_Av <- mean(SiteE_Cr53$Blanked_Concentration)

SiteE_Pb208 <- filter(SiteE_Data, metal == "Pb208")
SiteE_Pb208_Av <- mean(SiteE_Pb208$Blanked_Concentration)

SiteE_Av <- c(SiteE_As75_Av, SiteE_Cd111_Av, SiteE_Cd114_Av, SiteE_Cr52_Av, SiteE_Cr53_Av, SiteE_Pb208_Av)

SiteE_As75_er <- sd(SiteE_As75$Blanked_Concentration_Error)
SiteE_Cd111_er <- sd(SiteE_Cd111$Blanked_Concentration_Error)
SiteE_Cd114_er <- sd(SiteE_Cd114$Blanked_Concentration_Error)
SiteE_Cr52_er <- sd(SiteE_Cr52$Blanked_Concentration_Error)
SiteE_Cr53_er <- sd(SiteE_Cr53$Blanked_Concentration_Error)
SiteE_Pb208_er <- sd(SiteE_Pb208$Blanked_Concentration_Error)
SiteE_er <- c(SiteE_As75_er, SiteE_Cd111_er, SiteE_Cd114_er, SiteE_Cr52_er, SiteE_Cr53_er, SiteE_Pb208_er)
#---------
SiteF_As75 <- filter(SiteF_Data, metal == "As75")
SiteF_As75_Av <- mean(SiteF_As75$Blanked_Concentration)

SiteF_Cd111 <- filter(SiteF_Data, metal == "Cd111")
SiteF_Cd111_Av <- mean(SiteF_Cd111$Blanked_Concentration)

SiteF_Cd114 <- filter(SiteF_Data, metal == "Cd114")
SiteF_Cd114_Av <- mean(SiteF_Cd114$Blanked_Concentration)

SiteF_Cr52 <- filter(SiteF_Data, metal == "Cr52")
SiteF_Cr52_Av <- mean(SiteF_Cr52$Blanked_Concentration)

SiteF_Cr53 <- filter(SiteF_Data, metal == "Cr53")
SiteF_Cr53_Av <- mean(SiteF_Cr53$Blanked_Concentration)

SiteF_Pb208 <- filter(SiteF_Data, metal == "Pb208")
SiteF_Pb208_Av <- mean(SiteF_Pb208$Blanked_Concentration)

SiteF_Av <- c(SiteF_As75_Av, SiteF_Cd111_Av, SiteF_Cd114_Av, SiteF_Cr52_Av, SiteF_Cr53_Av, SiteF_Pb208_Av)

SiteF_As75_er <- sd(SiteF_As75$Blanked_Concentration_Error)
SiteF_Cd111_er <- sd(SiteF_Cd111$Blanked_Concentration_Error)
SiteF_Cd114_er <- sd(SiteF_Cd114$Blanked_Concentration_Error)
SiteF_Cr52_er <- sd(SiteF_Cr52$Blanked_Concentration_Error)
SiteF_Cr53_er <- sd(SiteF_Cr53$Blanked_Concentration_Error)
SiteF_Pb208_er <- sd(SiteF_Pb208$Blanked_Concentration_Error)
SiteF_er <- c(SiteF_As75_er, SiteF_Cd111_er, SiteF_Cd114_er, SiteF_Cr52_er, SiteF_Cr53_er, SiteF_Pb208_er)
#---------
Site_metals <- c("As75", "Cd111", "Cd114", "Cr52", "Cr53", "Pb208")
Site_Av <- data.frame(Site_metals, SiteA_Av, SiteB_Av, SiteC_Av, SiteD_Av, SiteE_Av, SiteF_Av)
Site_er <- data.frame(Site_metals, SiteA_er, SiteB_er, SiteC_er, SiteD_er, SiteE_er, SiteF_er)

Site_Av
Site_er
```


9) Clean up the environment
#Consider other errors and posible effects on uncertanty
```{r}
rm(list = ls()[!(ls() %in% c("ICPMS","sample_data"))])
```

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
AA_Data
```{r}
AA_tidy_example #name of data_frame being analyzed
```

```{r}
sample_sites <- unique(filter(AA_tidy_example, site!="MB", site!="")$site) # excludeing method blank and quality control from list of sites
#Only Cr so no need to seperate by metal
AA_tidy_filter <- filter(AA_tidy_example, site!="MB", site!="")

#Preview the lists to check for potential issues:
sample_sites
AA_tidy_filter
```

```{r}
#what we want
#concentration Cr(x) to mean abs(y)
conc_Cr <- c(AA_tidy_example$concentration)
AA_abs <- c(AA_tidy_example$mean_abs)

fit <- lm(AA_abs ~ conc_Cr)
summary(fit)

slope <- fit$coefficients[2]
intercept <- fit$coefficients[1]
slope_uncertanty <- sqrt(diag(vcov(fit)))[2]
intercept_uncertanty <- sqrt(diag(vcov(fit)))[1]
y_uncertanty <- sqrt(deviance(fit)/df.residual(fit))

slope
slope_uncertanty
intercept
intercept_uncertanty
print("Residual standard error")
print(y_uncertanty)

paste("y(+/-", y_uncertanty, ")=", slope, "(+/-", slope_uncertanty, ")x+", intercept, "(+/-", intercept_uncertanty, ")")

plot(conc_Cr, AA_abs, main="AA Data [Cr]",
  xlab="concentration of Cr (ppm)", ylab="Absorbance")
abline(fit)
```

```{r concentrations}
for (mean_abs in AA_tidy_filter){
xCr <- ((AA_tidy_filter$mean_abs-intercept)/slope)

#Uncertanties
xCr_uncertanty <-sqrt(((sqrt((y_uncertanty)^2 + (intercept_uncertanty)^2)))^2 + (slope_uncertanty/slope)^2)*xCr
}

#Preview
xCr
xCr_uncertanty
```

```{r average MB}
AA_MB <- subset(AA_tidy_example %>%
  filter(site == "MB"), select = -c(concentration, percent_rsd, mass_of_soil, type, ID))#(micrograms/kg)
AA_MB

#average & uncertanty
MB_absAve <- mean(AA_MB$mean_abs)
MB_sdAve <- sd(AA_MB$mean_abs)
MB_absAve
MB_sdAve
```

```{r subtract MB-absorbance from Cr mean_abs}
for (mean_abs in AA_tidy_filter){
yCr_corrected <- ((AA_tidy_filter$mean_abs-MB_absAve))

#Uncertanties
yCr_corrected_uncertanty <- sqrt((y_uncertanty)^2 + (MB_sdAve)^2)
}

yCr_corrected
yCr_corrected_uncertanty
```

```{r}
Cr_d1 <- data.frame( AA_tidy_filter$sample_key, AA_tidy_filter$site, xCr, xCr_uncertanty, yCr_corrected, yCr_corrected_uncertanty)
Cr_data <- Cr_d1 %>% 
  rename(
    sample_key = AA_tidy_filter.sample_key,
    site = AA_tidy_filter.site,
    AA_conc = xCr,
    AA_conc_error = xCr_uncertanty,
    AA_abs = yCr_corrected,
    AA_abs_error = yCr_corrected_uncertanty
    )
Cr_data
```
```{r}
AA_conc_correct <- Cr_data$AA_conc*1000
AA_conc_error_correct <- Cr_data$AA_conc_error*1000

Cr_data_ppb <- data.frame(Cr_data$sample_key, Cr_data$site, AA_conc_correct, AA_conc_error_correct)

Cr_data_ppb
```

```{r section by section TEST}
vol_e <- 1
mass_e <- 0.001
dil_1010_e <- sqrt(1^2 + 10^2)
dil_e <- sqrt((dil_1010_e/1010)^2 + (1/10)^2) #error 
AAsample_data <- merge(AA_tidy_filter, Cr_data) %>% 
  unique()%>%
  mutate(AAconc_blanked = AA_conc*(total_volume/1000)/(mass_of_soil/1000),
         AAconc_blanked_error = AAconc_blanked*
           sqrt((AA_conc_error/AA_conc)^2 + 
                  (dil_e/101)^2 +
                  (mass_e/mass_of_soil)^2 +
                  (vol_e/total_volume)^2),
         conc_unblanked = xCr*(total_volume/1000)/(mass_of_soil/1000),
         conc_unblanked_error = conc_unblanked*
           sqrt((xCr_uncertanty/xCr)^2 +
                  (dil_e/101)^2 +
                  (mass_e/mass_of_soil)^2 +
                  (vol_e/total_volume)^2))
AA_sample_data<- subset(AAsample_data, select = -c(ID, concentration, type, mass_of_soil, total_volume, percent_rsd, analyst, mean_abs, AA_conc, AA_conc_error, AA_abs, AA_abs_error, xCr, xCr_uncertanty))

AA_sample_data

#A test A thought
AA_conc_correct2 <- AA_sample_data$AAconc_blanked*1000
AA_conc_error_correct2 <- AA_sample_data$AAconc_blanked_error*1000

Cr_data_ppb2 <- data.frame(Cr_data$sample_key, Cr_data$site, AA_conc_correct2, AA_conc_error_correct2)

Cr_data_ppb2
```

```{r}
AA_data_conc <- Cr_data_ppb2 %>% 
  rename(
    AA_conc = AA_conc_correct2,
    AA_conc_error = AA_conc_error_correct2,
    sample_key = Cr_data.sample_key,
    site = Cr_data.site
    )
AA_data_conc
```


+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

```{r}
ICPMS_d1 <- subset(ICPMS_sample_data, select = -c(metal, analyst, X1, conc_unblanked, conc_unblanked_error))
ICPMS_d2 <- subset(ICPMS_sample_data, select = -c(metal, analyst, X1, conc_unblanked, conc_unblanked_error))

ICPMS_conc <- ICPMS_d1 %>% 
  rename(
    ICPMS_conc = conc_blanked,
    ICPMS_conc_error = conc_blanked_error
    )

ICPMS_conc
```

```{r}
Data_Compair <- merge(ICPMS_conc, AA_data_conc)
Data_Compair_av <- Data_Compair%>%
  group_by(site)%>%
  summarise(ICPMS_av = mean(ICPMS_conc), ICPMS_av_error = sd(ICPMS_conc), AA_av = mean(AA_conc), AA_av_error = sd(AA_conc), length = length(site), CI_ICPMS = (qnorm(0.975)*ICPMS_av_error/sqrt(length)), CI_AA = (qnorm(0.975)*AA_av_error/sqrt(length)))

#Aved data -> make bar plot of AA and ICPMS w/ CI as error bars ppb[] vs Site, color AA/ICPMS
#make bar plot of ICPMS [metal] vs site, fill=metal

Data_Compair
Data_Compair_av
```

Save csv file
```{r}
write.csv(Data_Compair, file = "~/Chem313Lab05AJed/Chem311_JCWSoil/Data/Cr_AA_ICPMS_data.csv")
```




Bar graph?
```{r}
AllData <- c(Data_Compair$ICPMS_conc, Data_Compair$AA_conc)
Double_key <- c(Data_Compair$sample_key, Data_Compair$sample_key)
Double_site <- c(Data_Compair$site, Data_Compair$site)
AllError <- c(Data_Compair$ICPMS_conc_error, Data_Compair$AA_conc_error)
DataType <- c("ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","ICPMS","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA","AA")
All <- data.frame(Double_key, Double_site, AllData, DataType)
All
All_BarPlot <- ggplot(data=All, aes(x=Double_key, y=AllData, fill =Double_site, color = DataType)) + scale_fill_manual(values=c("#900C3F", "#9B8800", "#4B9B00", "#007C9B", "#50009B", "#94009B", "#530D6D")) + geom_bar(stat="identity", position=position_dodge()) + geom_errorbar(aes(ymin=AllData-AllError, ymax=AllData+AllError), width=.2, position=position_dodge(0.9))
All_BarPlot
```

Confidence Intervals:
```{r}
#ICPMS_AllData %>%
  #group_by()
CI = (qnorm(0.975)*sd()/sqrt(length(ICPMS_AllData_Av$metal == "As75")))
#CI95 <- qt(0.95, df= (length(ICPMS_AllData_Av$metal == "As75")-1)*sd(ICPMS_AllData_Av$metal == "As75")
```



FOR REPORT:
```{r}
#1 Include both ICP-MS and AA calibration curves with descriptive captions in your lab report

#2 Calculate the average [Pb], [Cr], [Cd], and [As] as measured by ICP-MS from all of the class data for each soil sample
    # Calculate the 95% CI of the range of concentrations for each metal ( ̅x ± ts /√n)

#3Calculate the average [Pb], [Cr], [Cd], and [As] measured in the class average of method blank and Buffalo River standard soil quality control check samples. Compare the concentrations observed in the QC soil sample to reported concentrations (data sheet on the QC soil is on the moodle) --> what?

#4 Calculate the average [Cr] as measured by AA
    # Calculate the 95% CI of the range of concentrations for each metal ( ̅x ± ts /√n)

#5 Do the [Cr] measured by AA and ICP-MS agree, within error?

#6 Calculated the average measured concentrations of all metals in each soil sample, in mg/kg dry soil. This will require accounting for all dilutions and the initial mass of soil digested. Show your calculation for one of the metals
```

